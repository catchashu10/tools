#!/usr/bin/env bash
# tmux-theme — switch gpakosz/.tmux colour themes
# Usage: tmux-theme <theme-name>
# Themes are stored in ~/.tmux/themes/<name>.conf
# Config file uses # THEME_START / # THEME_END markers

THEMES_DIR="$HOME/.tmux/themes"
CONF="$HOME/.tmux.conf.local"
THEME_NAME="$1"

if [ -z "$THEME_NAME" ]; then
    echo "Available themes:"
    for f in "$THEMES_DIR"/*.conf; do
        basename "$f" .conf
    done
    exit 0
fi

THEME_FILE="$THEMES_DIR/$THEME_NAME.conf"

if [ ! -f "$THEME_FILE" ]; then
    echo "Error: Theme '$THEME_NAME' not found"
    echo "Available themes:"
    for f in "$THEMES_DIR"/*.conf; do
        basename "$f" .conf
    done
    exit 1
fi

# Build the replacement block — strip any \r (CRLF) as safety net
THEME_CONTENT=$(tr -d '\r' < "$THEME_FILE")

# Replace everything between THEME_START and THEME_END markers
if ! awk -v theme="$THEME_CONTENT" '
    /^# THEME_START/ {
        print "# THEME_START"
        print theme
        skip = 1
        next
    }
    /^# THEME_END/ {
        print "# THEME_END"
        skip = 0
        next
    }
    !skip { print }
' "$CONF" > "$CONF.tmp"; then
    rm -f "$CONF.tmp"
    tmux display-message "Error: failed to apply theme '$THEME_NAME'" 2>/dev/null
    echo "Error: awk failed to process config"
    exit 1
fi

mv "$CONF.tmp" "$CONF"

# Reload tmux config (-q suppresses parsing warnings)
tmux source-file -q "$HOME/.tmux.conf" 2>/dev/null

# Save current theme name and show message via tmux status line
tmux set-environment -g TMUX_THEME "$THEME_NAME" 2>/dev/null
tmux display-message "theme: $THEME_NAME"
