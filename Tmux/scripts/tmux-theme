#!/usr/bin/env bash
# tmux-theme — switch gpakosz/.tmux colour themes
# Usage: tmux-theme <theme-name>
# Themes are stored in ~/.tmux/themes/<name>.conf
# Config file uses # THEME_START / # THEME_END markers

THEMES_DIR="$HOME/.tmux/themes"
CONF="$HOME/.tmux.conf.local"
# Resolve symlink so mv writes back to the real file, not replaces the link
[ -L "$CONF" ] && CONF="$(readlink "$CONF")"
THEME_NAME="$1"

if [ -z "$THEME_NAME" ]; then
    echo "Available themes:"
    for f in "$THEMES_DIR"/*.conf; do
        basename "$f" .conf
    done
    exit 0
fi

THEME_FILE="$THEMES_DIR/$THEME_NAME.conf"

if [ ! -f "$THEME_FILE" ]; then
    echo "Error: Theme '$THEME_NAME' not found"
    echo "Available themes:"
    for f in "$THEMES_DIR"/*.conf; do
        basename "$f" .conf
    done
    exit 1
fi

# Replace everything between THEME_START and THEME_END markers
# Uses getline to read theme file directly — avoids passing multi-line
# content via -v which breaks on macOS BSD awk
if ! awk -v theme_file="$THEME_FILE" '
    /^# THEME_START/ {
        print "# THEME_START"
        while ((getline line < theme_file) > 0) {
            gsub(/\r$/, "", line)
            print line
        }
        close(theme_file)
        skip = 1
        next
    }
    /^# THEME_END/ {
        print "# THEME_END"
        skip = 0
        next
    }
    !skip {
        gsub(/\r$/, "")
        print
    }
' "$CONF" > "$CONF.tmp"; then
    rm -f "$CONF.tmp"
    tmux display-message "Error: failed to apply theme '$THEME_NAME'" 2>/dev/null
    echo "Error: awk failed to process config"
    exit 1
fi

mv "$CONF.tmp" "$CONF"

# Update starship palette to match
STARSHIP_CONF="$HOME/.config/starship.toml"
[ -L "$STARSHIP_CONF" ] && STARSHIP_CONF="$(readlink "$STARSHIP_CONF")"
sed -i "s/^palette = .*/palette = \"$THEME_NAME\"/" "$STARSHIP_CONF"

# Reload tmux config (-q suppresses parsing warnings)
tmux source-file -q "$HOME/.tmux.conf" 2>/dev/null

# Save current theme name and show message via tmux status line
tmux set-environment -g TMUX_THEME "$THEME_NAME" 2>/dev/null
tmux display-message "theme: $THEME_NAME"
